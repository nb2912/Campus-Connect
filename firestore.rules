rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper: Is the user a student at SRM?
    function isStudent() {
      return request.auth != null && request.auth.token.email.split('@')[1] == 'srmist.edu.in';
    }

    // Profiles: Anyone authenticated can read, only the owner can write
    // Exception: Any SRM student can update just the 'points' field (for join/leave XP)
    match /users/{userId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == userId && isStudent();
      allow update: if request.auth != null && (
        // Owner can update anything
        request.auth.uid == userId ||
        // Any student can update ONLY the points field (used in join/leave transactions)
        (isStudent() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['points']))
      );
      allow delete: if request.auth != null && request.auth.uid == userId;
    }

    // Requests: Must be an SRM student to read or create
    match /requests/{requestId} {
      allow read: if isStudent();
      allow create: if isStudent();
      allow update: if isStudent() && (
        resource.data.creatorId == request.auth.uid || 
        request.resource.data.participants.size() > resource.data.participants.size() ||
        (request.resource.data.participants.size() < resource.data.participants.size() && resource.data.participants.hasAny([request.auth.uid]))
      );
      allow delete: if isStudent() && resource.data.creatorId == request.auth.uid;

      // Nested Chat Messages
      match /messages/{messageId} {
        allow read: if isStudent();
        allow create: if isStudent();
      }
    }

    // Notifications: Private to the receiver
    match /notifications/{notificationId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.receiverId;
      allow create: if isStudent();
      allow update: if request.auth != null && request.auth.uid == resource.data.receiverId;
    }
  }
}
